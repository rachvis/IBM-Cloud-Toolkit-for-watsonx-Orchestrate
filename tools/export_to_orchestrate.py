"""
export_to_orchestrate.py â€” Export Tools to watsonx Orchestrate on IBM Cloud
=============================================================================
This script helps you import the IBM Cloud toolkit into
watsonx Orchestrate on IBM Cloud using the OpenAPI spec
generated by register_tools.py.

Usage:
  python3 tools/export_to_orchestrate.py

The script will:
  1. Validate the OpenAPI spec exists
  2. Show your IBM Cloud Orchestrate instance details
  3. Give step-by-step instructions for importing into Orchestrate on IBM Cloud
"""

import os
import sys
import json
from pathlib import Path


def main():
    config_dir = Path(__file__).parent.parent / "config"
    spec_path = config_dir / "ibm_cloud_toolkit_openapi.json"
    manifest_path = config_dir / "tool_manifest.json"

    orchestrate_instance = os.getenv("WATSONX_ORCHESTRATE_INSTANCE_URL", "")
    orchestrate_api_key = os.getenv("IBM_CLOUD_API_KEY", "")
    region = os.getenv("IBM_CLOUD_REGION", "us-south")

    print()
    print("=" * 65)
    print("  IBM Cloud Toolkit â†’ watsonx Orchestrate on IBM Cloud")
    print("=" * 65)
    print()

    if not spec_path.exists():
        print("âŒ OpenAPI spec not found. Run this first:")
        print("   python3 tools/register_tools.py")
        sys.exit(1)

    with open(manifest_path) as f:
        manifest = json.load(f)

    print(f"âœ… Toolkit: {manifest['toolkit_name']} v{manifest['toolkit_version']}")
    print(f"   Tools available: {manifest['tool_count']}")
    print()

    if orchestrate_instance:
        print(f"âœ… Orchestrate Instance URL: {orchestrate_instance}")
    else:
        print("âš ï¸  WATSONX_ORCHESTRATE_INSTANCE_URL not set in .env")
        print("   Add it to use the API import method below.")
    print()

    # â”€â”€â”€ METHOD 1: IBM Cloud Console UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("â”€" * 65)
    print("  METHOD 1 â€” Import via IBM Cloud Console UI (Recommended)")
    print("â”€" * 65)
    print()
    print("  1. Log in to IBM Cloud:")
    print("     â†’ https://cloud.ibm.com")
    print()
    print("  2. From the Navigation menu, go to:")
    print("     'AI / Machine Learning' â†’ 'watsonx Orchestrate'")
    print()
    print("  3. Open your watsonx Orchestrate instance.")
    print()
    print("  4. In the left sidebar, click 'Skills & Apps'")
    print()
    print("  5. Click '+ Add skills' â†’ 'From OpenAPI file'")
    print()
    print(f"  6. Upload this file:")
    print(f"     ğŸ“„ {spec_path.absolute()}")
    print()
    print(f"  7. Review the {manifest['tool_count']} tools listed â†’ click 'Add'")
    print()
    print("  8. Go to 'Agent Builder' â†’ open or create your agent â†’")
    print("     add the 'IBM Cloud Toolkit' skill set to your agent.")
    print()

    # â”€â”€â”€ METHOD 2: watsonx Orchestrate REST API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("â”€" * 65)
    print("  METHOD 2 â€” Import via watsonx Orchestrate API")
    print("â”€" * 65)
    print()
    print("  Prerequisites:")
    print("   â€¢ WATSONX_ORCHESTRATE_INSTANCE_URL set in your .env")
    print("   â€¢ IBM Cloud IAM API key (IBM_CLOUD_API_KEY)")
    print()
    print("  Step 1 â€” Get an IAM token:")
    print()
    print('   curl -X POST "https://iam.cloud.ibm.com/identity/token" \\')
    print('     -H "Content-Type: application/x-www-form-urlencoded" \\')
    print('     -d "grant_type=urn:ibm:params:oauth:grant-type:apikey&apikey=YOUR_API_KEY"')
    print()
    print("  Step 2 â€” Import the OpenAPI spec:")
    print()
    instance_url = orchestrate_instance or "https://YOUR_INSTANCE.orchestrate.cloud.ibm.com"
    print(f'   curl -X POST "{instance_url}/api/v1/skills/import" \\')
    print('     -H "Authorization: Bearer YOUR_IAM_TOKEN" \\')
    print('     -H "Content-Type: application/json" \\')
    print(f'     -d @{spec_path.absolute()}')
    print()

    # â”€â”€â”€ METHOD 3: IBM Cloud CLI + watsonx plugin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("â”€" * 65)
    print("  METHOD 3 â€” Import via IBM Cloud CLI")
    print("â”€" * 65)
    print()
    print("  Step 1 â€” Install the IBM Cloud CLI (if not already):")
    print("   curl -fsSL https://clis.cloud.ibm.com/install/osx | sh")
    print()
    print("  Step 2 â€” Log in:")
    print("   ibmcloud login --apikey YOUR_API_KEY -r", region)
    print()
    print("  Step 3 â€” Target your watsonx Orchestrate instance:")
    print("   ibmcloud resource service-instances --service-name watsonx-orchestrate")
    print()
    print("  Step 4 â€” Import skills via the Orchestrate CLI plugin:")
    print("   ibmcloud wx-orchestrate skills import \\")
    print(f"     --spec {spec_path.absolute()}")
    print()

    # â”€â”€â”€ Configure .env for Orchestrate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("â”€" * 65)
    print("  CONFIGURE YOUR .ENV FILE FOR ORCHESTRATE")
    print("â”€" * 65)
    print()
    print("  Add these variables to your .env file:")
    print()
    print("   # watsonx Orchestrate on IBM Cloud")
    print("   WATSONX_ORCHESTRATE_INSTANCE_URL=https://YOUR_INSTANCE.orchestrate.cloud.ibm.com")
    print("   WATSONX_ORCHESTRATE_REGION=us-south   # or eu-de, jp-tok, etc.")
    print()
    print("  Find your instance URL:")
    print("   IBM Cloud Console â†’ Resource list â†’ AI/ML â†’")
    print("   watsonx Orchestrate â†’ your instance â†’ Manage â†’ Credentials")
    print()

    # â”€â”€â”€ Verify after import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("â”€" * 65)
    print("  VERIFY â€” Test prompts after importing")
    print("â”€" * 65)
    print()
    print("  In watsonx Orchestrate chat, try these prompts:")
    print()
    print('  ğŸ’¬ "List all my Code Engine projects"')
    print('  ğŸ’¬ "Show me errors from the last hour in my logs"')
    print('  ğŸ’¬ "What is my database CPU usage over the past 30 minutes?"')
    print('  ğŸ’¬ "List my IBM Cloud Database instances"')
    print()

    print("â”€" * 65)
    print("  FILES GENERATED")
    print("â”€" * 65)
    print()
    print(f"  ğŸ“„ OpenAPI Spec   â†’ {spec_path}")
    print(f"  ğŸ“„ Tool Manifest  â†’ {manifest_path}")
    print(f"  ğŸ“„ Tool Summary   â†’ {config_dir / 'tools_summary.txt'}")
    print()
    print("âœ… Ready to import into watsonx Orchestrate on IBM Cloud!")
    print()


if __name__ == "__main__":
    main()
